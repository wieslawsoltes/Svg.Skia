# Svg.Ast Options Review

## Analysis

### Documentation & Planning Drift
- `SVG-AST-Options.md:94-96` still claims *“SvgAstBuilder … maintains parent links”*, but `SvgAstElement` only exposes immutable children with no parent pointer in `src/Svg.Ast/SvgAstNodes.cs` and the renderer/code generators never receive parent information. The discrepancy makes it unclear whether parent tracking is required or safely ignored by downstream consumers.
- The same plan marks item 9.3 as done and advertises a `tools/SvgAst.Cli` with `parse`, `dump`, `validate`, and `render` commands (`SVG-AST-Options.md:129-130`), yet the repository only contains `tools/Svg.Metadata.Generator`—there is no CLI project, documentation, or tests. Tooling/integration guidance in `docs/SvgAst.md` therefore references assets that do not exist.
- Phase 10 of the plan explicitly calls out gradients, patterns, masks, and text layout (`SVG-AST-Options.md:134-137`), but the current resolver in `src/Svg.Model/Ast/SvgAstPaintServerResolver.cs:67-80` only registers gradients, masks, and clip-paths; there is no pattern lookup, and text rendering is still a single `DrawText` call (`src/Svg.Model/Ast/SvgAstSkiaEmitter.cs:446-477`). The planning document has drifted far enough from the codebase that it is difficult to gauge what is complete or missing.

### Parsing & AST gaps
- Namespace declarations are applied **before** a new scope is pushed in `src/Svg.Ast/SvgAstBuilder.cs:144-205`, so child-specific `xmlns:*` attributes leak into sibling elements until the parent scope is popped. Combined with the fact that `SvgNamespaceResolver.Resolve` falls back to returning an uninitialized local (`src/Svg.Ast/SvgNamespaceResolver.cs:58-59`), namespace resolution is both leaky and incorrect whenever prefixes shadow each other.
- `SvgAstElementFlags`/`SvgAstAttributeFlags` are defined in `src/Svg.Ast/SvgAstNodes.cs:20-41` but never populated—elements never record when they carry presentation attributes, `style`, or `id`, so downstream code has to re-scan attributes repeatedly. Likewise, the plan promised cached metadata (“cached flags” in `SVG-AST-Options.md:91-92`) that never materialized.
- `SvgAstBuilder` only forwards comments, CDATA, processing instructions, and text from `XmlDocumentSyntax.PrecedingMisc`/`FollowingMisc` (`src/Svg.Ast/SvgAstBuilder.cs:121-140`). XML declarations and document type nodes are silently dropped, so the AST is not “full fidelity” as advertised.
- Parser diagnostics rely on reflection over `DiagnosticInfo.Span` and `DiagnosticInfo.GetSpan()` (`src/Svg.Ast/SvgAstBuilder.cs:437-453`). This hack is brittle (internal APIs could disappear) and still falls back to the entire `node.Span` when the reflection call fails, which is precisely the bug documented in `docs/SvgAst-Review.md`.

### Emission & Rendering gaps
- Numeric parsing simply strips trailing letters or `%` and parses the remaining float (`src/Svg.Model/Ast/SvgAstRenderUtilities.cs:111-146`). As a result, all units (`px`, `pt`, `cm`, `em`, etc.) and percentages collapse into the same number space. Geometry helpers such as `GetNumber` (`src/Svg.Model/Ast/SvgAstSkiaEmitter.cs:283-333`) therefore treat `width="50%"` as `0.5` user units instead of resolving it against the viewport/parent dimensions.
- `SvgAstSkiaEmitter.RenderElement` handles only a handful of elements (`svg`, `g`, `defs`, basic shapes, and `text`) as shown in `src/Svg.Model/Ast/SvgAstSkiaEmitter.cs:146-182`. Core SVG constructs—`use`, `symbol`, `image`, `pattern`, `marker`, `filter`, `textPath`, gradients on strokes, etc.—are completely ignored, so large portions of the spec still fall back to the legacy DOM path.
- Text rendering collapses the subtree into a single collapsed string and draws it at one `(x,y)` location (`src/Svg.Model/Ast/SvgAstSkiaEmitter.cs:446-515`). It does not handle per-character positioning (`x`, `y`, `dx`, `dy`, `rotate`), anchors, multiple `tspan` coordinates, or bidi text, so even moderately complex text fails to render.
- Element transforms overwrite the entire canvas matrix via `_canvas.SetMatrix(matrix)` (`src/Svg.Model/Ast/SvgAstSkiaEmitter.cs:128-144`). Because the previous matrix is restored only after the element finishes, nested transforms never compose with their parents—they reset to the child’s matrix and drop the parent transform stack. Every `<g transform>` therefore behaves as if applied in the root coordinate space instead of relative to its ancestors.
- Masks are treated as rectangular clips: `ApplyMask` merely clips to `maskRect` (`src/Svg.Model/Ast/SvgAstSkiaEmitter.cs:568-583`), and the resolver only stores positional metadata without rendering mask content (`src/Svg.Model/Ast/SvgAstPaintServerResolver.cs:785-834`). There is no support for luminance/alpha masks, mask children, or mask compositing.
- CSS/presentation attributes are limited to a small hard-coded set (`src/Svg.Model/Ast/SvgAstRenderState.cs:155-210`). There is no cascade, no support for `class` selectors, no `<style>` element parsing, and no handling of `currentColor`, `inherit`, or fallback values. Anything beyond inline `style` attributes is silently ignored.
- Patterns are never parsed or resolved: the resolver switch (`src/Svg.Model/Ast/SvgAstPaintServerResolver.cs:67-80`) never inspects `<pattern>` elements and `SvgAstPaintServerResolver.TryCreateShader` only knows about gradients. Yet the plan claims patterns are handled in Phase 10.

### Runtime & Tooling
- `SvgAstDomEmitter` uses reflection to call the internal `Svg.SvgElementFactory.SetPropertyValue` (`src/Svg.Model/Ast/Emit/SvgAstDomEmitter.cs:54-56`). This is fragile and makes the emitter dependent on the private surface area of the legacy DOM implementation.
- The advertised CLI workflow is missing entirely (see `SVG-AST-Options.md:129-130`), so there is no automated way to parse/validate/render SVGs outside of the Avalonia playground. Tooling coverage is therefore materially worse than what the planning document suggests.

## Plan

1. [ ] **Realign documentation and tooling.** Update `SVG-AST-Options.md` to reflect the current state (parent links, validator, missing CLI), and either build the promised `tools/SvgAst.Cli` or remove the references from `SVG-AST-Options.md:129-130`/`docs/SvgAst.md`. Add regression tests/docs so future drift is visible.
2. [ ] **Fix namespace scoping and resolution.** Push a scope before processing element attributes in `src/Svg.Ast/SvgAstBuilder.cs:144-205`, repair `SvgNamespaceResolver.Resolve` (`src/Svg.Ast/SvgNamespaceResolver.cs:58-59`), and add tests covering nested prefix declarations/shadowing.
3. [ ] **Populate AST metadata flags and parent info.** Decide whether parent pointers are required; if so, add them to `SvgAstNode`. Regardless, set `SvgAstElementFlags`/`SvgAstAttributeFlags` in `SvgAstBuilder` so consumers can rely on cached metadata rather than rescanning attributes.
4. [ ] **Eliminate reflection for diagnostics.** Replace `CreateDiagnosticSpanAccessor` with a resilient path (e.g., upstream changes to `Microsoft.Language.Xml` or wrapper APIs) and add tests that assert parser diagnostics point at the correct spans.
5. [ ] **Preserve full XML trivia.** Extend `TransformMisc` (`src/Svg.Ast/SvgAstBuilder.cs:121-140`) to surface XML declarations, DOCTYPE nodes, and entity references so “full fidelity AST” is accurate.
6. [ ] **Implement CSS/cascade and style inheritance.** Teach `SvgAstStyleHelper` (`src/Svg.Model/Ast/SvgAstRenderState.cs:155-210`) about `class` attributes, `<style>` blocks, `currentColor`, `inherit`, and presentation attribute inheritance. Store normalized style info on AST nodes/flags to avoid re-parsing.
7. [ ] **Make numeric parsing unit-aware.** Replace the current `StripUnit` path (`src/Svg.Model/Ast/SvgAstRenderUtilities.cs:111-146`) with a proper length parser that understands units and percentages relative to viewport/user units; propagate the resolved values to geometry helpers so attributes like `width="50%"` render correctly.
8. [ ] **Fix transform/mask composition.** Update `PushTransform` (`src/Svg.Model/Ast/SvgAstSkiaEmitter.cs:128-144`) to concat matrices instead of resetting them, and rework mask handling (`src/Svg.Model/Ast/SvgAstSkiaEmitter.cs:568-583`, `src/Svg.Model/Ast/SvgAstPaintServerResolver.cs:785-834`) to render mask content (luminance/alpha) rather than clipping to bounding rectangles.
9. [ ] **Broaden emitter coverage.** Add support for `use`, `symbol`, `image`, `pattern`, `marker`, `filter`, `textPath`, and richer text layout inside `SvgAstSkiaEmitter` (`src/Svg.Model/Ast/SvgAstSkiaEmitter.cs:146-182`, `src/Svg.Model/Ast/SvgAstSkiaEmitter.cs:446-515`). Patterns require new paint-server plumbing in `SvgAstPaintServerResolver`.
10. [ ] **Harden DOM interoperability.** Replace the reflection-based setter in `SvgAstDomEmitter` (`src/Svg.Model/Ast/Emit/SvgAstDomEmitter.cs:54-56`) with a supported API (custom factory or internal hook) and add tests so regressions are caught when upgrading the legacy DOM dependency.

Each item should carry its own unit tests (AST, renderers, or tooling) so we can prove the “fully working solution” described in `SVG-AST-Options.md` is actually implemented.
